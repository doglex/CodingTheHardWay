[TOC]
<h1> 计算机网络 </h1>

#概念
计算机网络：通过通信设备与线路连接起来，由软件实现`资源共享`和`信息传递`的计算机系统。
+ 互连：连通
+ 自治：无主从关系
+ 资源共享
+ 分布式处理
+ 可靠性
+ 负载均衡

网路组成
+ 硬件
+ 软件
+ 协议

工作方式
+ 边缘部分(端系统)：用户可以直接使用 C/S, P2P
+ 核心部分: 为边缘服务，包括交换机、路由器等

功能组成
+ `通信子网`：实现数据通信，即`传输层以下`
+ `资源子网`：实现数据处理(共享)， 即`会话层以上`

网路分类
+ 按范围： 广域网WAN(交换技术)、城域网MAN、局域网WAN(广播技术)、个人局域网PAN
+ 使用者：共用网、专用网(军队、银行)
+ 交换技术：电路交换、报文交换、分组交换
+ 拓扑：总线型、星型、环形、网状(广域网)
+ 传输技术：广播式(共享公共信道)、点对点(分组存储转发+路由选择)

标准
+ 法定标准：比如OSI
+ 事实标准：TCP/IP
+ 自己怎么提RFC：Request For Comments：(1)搞个草案(2)建议标准~~(3)草案标准~~(3)因特网标准
+ ISO标准化组织，ITU指定通信规则，IEEE是学术机构，IETF是工程任务组

性能指标
+ 速率： bps, Mbps (比特率，不是Byte，是bit)
+ `带宽` ：模拟信号时指频率Hz，数字信号时指`最高速率`。也是bps
+ 吞吐量：一样的，也是bps
+ 时延：从链路一端到另一端的 秒数 = 发送时延(也叫传输时延)+传播时延+排队时延+处理时延
+ 时延带宽积：传播时延 x 带宽  ，表示了信息量是多少bit。就是有多少个bit在路上
+ 往返时延RTT： 发送方得到反馈的时间差。RTT越大，在收到确认前，可以发送更多时间。RTT = 2x传播时延+末端处理时延

利用率
+ 信道利用率：有数据通过时间占比
+ 网络利用率：信道利用率加权平均

网络分层的概念
+ 实体：同一层的实体称为`对等实体`
+ 协议：对等实体间的数据交换规则 (水平方向)
+ 接口：上层使用下层的入口
+ 服务：下层提供相邻上层的功能(垂直方向)
+ 网络分层是按照功能来分的
+ 7层模型：上面4层应用层、表示层、会话层、传输层看起来是`端到端`(端口)；下面3层网络层、链路层、物理层看起来是`点到点`，因为只负责传输不管传到哪里
+ 应用层：FTP、SMTP、HTTP
+ 表示层：数据格式转换、加密解密、数据压缩恢复
+ 会话层:有序传输、建立同步(SYN)。建立、管理、终止会话。校验点/同步点恢复通信。
+ 传输层：端到端通信，传报文段或者用户数据报。可靠传输、不可靠传输，差错控制、流量控制、复用分用。
+ 网络层：传输数据报。路由选择、流量控制、差错控制、拥塞控制
+ 数据链路层：传输帧。成帧、流量控制、差错控制、(信道)访问/接入控制
+ 物理层：传输比特。实现透明传输。定义接口特性。定义传输模式(单工、半双工、双工)、比特同步、比特编码

五层模型 OSI+TCP/IP模型
+ 应用层(无连接)
+ 传输层(无连接+面向连接)
+ 网络层
+ 数据链路层
+ 物理层

# 数据通信
+ 数据：有意义的符号序列。
+ 信号：数据传输过程中的存在形式。(数字信号离散，模拟信号连续)
+ 信源：生产数据的源头。
+ 信宿：消费数据的终点。
+ 信道：信号的传输媒介。
+ 单工：只能单向，一条信道
+ 半双工：同时只能单向，两条信道
+ 双工：可以同时发送接收，两条信道
+ 串行传输：单个bit通过单个信道。速度慢费用低，适合远距离
+ 并行传输：多个信道同时传多个bit。速度快费用高，适合近距离
+ 码元： 固定时长下的信号波形。可以携带多个bit
+ 码元宽度： 这个固定时长
+ 码元速率(即调制速率、符号速率、脉冲个数)：单位是波特 Baud /s = n bps . （比如1波特带有n个比特）
+ 基带信号：来自信源的信号，近传输用
+ 宽带信号：调制后放到一个特定频率的信号，远传输用

数字数据编码为数字信号
+ 非归零编码 NRZ
+ 归零编码 RZ
+ 曼切斯特编码
+ 反向不归零编码 NRZI
+ 差分曼切斯特编码
+ 4B/5B编码

数字数据调制为模拟信号
+ ASK调幅
+ FSK调频
+ PSK调相
+ QAM调幅+调相

模拟数据编码为数字信号
+ PCM 脉码调制：抽样、量化、编码

模拟信号调制为模拟信号
+ 频分复用

# 香农定理
+ 失真原因：码元传输速率、信号传输距离、噪声干扰、传输媒体质量
+ 失真现象：码间串扰，收到的信号波形失去了码元之间界限不清
+ 信道带宽：最高频率和最低频率之差
+ 奈氏准则：在理想低通(无噪声，带宽受限)下，避免码间串扰的极限传输速率是 2W Baud ， 即2W(logV/log2) bps。 W是信道带宽(Hz).
+ 因此可以通过提高一个码元表示的bit量来提高速率
+ 香农定理：带宽受限有噪声，信道极限传输速率是 W(log(1+S/N)/ log2) bps 。 S是信号平均功率，N是高斯噪声功率
+ 因为必有噪声，所以实际传输速率有上限。要保证信噪比

# 传输介质

导向性介质
+ 双绞线：里面有铜
+ 同轴电缆
+ 光纤：传递光脉冲，频率大

非导向性介质
+ 无线电波：每个方向都有，只要在通信距离内，穿透能力也强
+ 微波：固定直线方向。频段范围非常宽、数据率高：卫星通信、地面微波接力
+ 红外线、激光：需要转特殊格式

# 物理层设备
+ 中继器：再生数字信号。从而增加传输距离。需要两端网络完全相同。不能用太多，因为有延迟。
+ 集线器(多口中继器)：放大信号并转发。不能分割冲突域，上面的主机平分带宽。

# 数据链路层
+ 结点：主机、路由器
+ 链路： 两个结点间的物理通道
+ 数据链路： 两个结点间的逻辑通道
+ 帧： 链路层的协议数据单元、封装网络层数据报
+ 数据链路层：为网络层提供服务(无确认无连接服务、有确认无连接服务、有确认面向连接服务)。加强物理层传输原始比特率的功能。组帧。流量控制。差错控制。

组帧
+ 封装成帧:添加帧首部、帧尾部。
+ 透明传输：链路层看不见具体是什么比特的，都能通过
+ 字符计数法、字符填充法(就是转义这些SOH,start of header;EOT, end of transmission)，零比特填充法、违规编码法。

差错
+ 原因：电气特性导致全局差错(随机噪声)，外界原因导致局部差错(冲击噪声)
+ 位错：比特位出错
+ 帧错：丢失、重复、失序
+ 检错编码：奇偶校验吗(数1的个数)、循环冗余码CRC(多项式取余数)
+ 纠错编码：海明码(冗余位可以纠回有限错误)

> 这些协议无所谓在哪层，本来放链路层的，现在让传输层去实现了，让链路层更快一些了
`流量控制`
+ 原因：较高发送速度和较低接收能力不匹配，缓冲不来
+ 停止--等待协议：每发一帧，就等确认，确认后再接着发
+ 滑动窗口协议：后退N帧(GBN), 选择重传协议(SR)：收到一个确认，发送窗口可以往前移动一格。接收窗口=1是GBN，>1是SR
+ 可靠传输：接收的就是发送的东西

停止--等待协议
+ 每发一帧，就等确认，确认后再接着发
+ 每次发的时候有个计时器(比平均RTT长)，超出计时器就重发
+ 发送时需要有编号，确认收到需要有编号，这样对上
+ 收到重复的丢弃
+ ACK迟到了,来晚了的话发送方不管了，丢弃就好了
+ 优点是简单，缺点是信道利用率太低

GBN后退N帧协议
+ 发送窗口：发送发维持一组允许发送的帧的序号。
+ 接收窗口：接收发一组连续的允许接收帧的序号。
+ 发送方需要响应：(1)上层要发时，如果窗口满了先缓存数据(2)收到ACK时，`累积确认`(表示序号比n小的都已经确认了)，并且可以向前滑动发送了
 (3)超时事件，重传所有已发送但是未确认的帧。
+ 接收方做的事：需要`按序接收`，如果接收到了不连续的帧，后面的全部丢弃，并且重新ACK上一次正确的帧。
+ 若采用n个比特对帧编号，窗口大小应该在1<W<2^n-1。 太大的话没法区别新帧和旧帧，即排序不够用了。
+ 性能：(1)相比停止--等待协议，提高了信道利用率(2)重传时可能丢掉很多，可能使效率低。

SR 选择重传协议：改进GBN
+ 可以缓存乱序到达。设置单个确认，加大接收窗口，设置接收缓存。
+ 发送方：(1)滑动发送的时候，可能滑一大块，因为乱序确认，只要确认的都可以滑过去了。(2)每个帧有计时器，超时时重发那个帧就好了。
+ 接收方：如果接收窗口内的都可以接受，不管是否按序。那帧好了，就可以滑到下一个没好的地方。
+ 发送窗口比接收窗口大来不及，小没意义。WT=WR=2^(n-1)

信道划分介质访问控制
+ 点对点链路：两个相邻节点之间，没有第三者，比如PPP。常用于广域网。
+ 广播式链路：所有节点共享介质。常用于局域网。有总线型、星型。
+ 访问控制：共享信道上，两对节点间不要相互干扰。
+ 静态划分信道：频分多路复用FDM，时分多路复用TDM(统计时分复用STDM，都用的多给时间片)，波分多路复用WDM，码分多路复用CDM(正交码片，相加分离，做内积)。
+ 动态分配信道：轮询(令牌传递协议)，随机访问介质控制(ALOHA,CSMA,CSMA/CD, CSMA/CA)。随机的需要协调

ALOHA协议：不听就说
+ 想发就发，不管别人
+ 冲突重发
+ 在接收方检测差错。等待超时一个随机时间再重传

时隙ALOHA协议(改进)
+ 控制想发就发的随意性
+ 分成相等时间片
+ 发生冲突需要等待时间片

CSMA协议 (Carrier sense multiple access)：先听再说
+ CS:载波监听。检测到电压摆动值过大，认为别人在传数据，就先不发等空闲。
+ MA：多点接入
+ 推迟策略：(1)1-坚持CSMA：空闲直接传不等，忙的话就等空闲立刻就传，冲突的话(没收到确认)就等随机长时间再监听。
(2)非坚持CSMA：忙的话就等一个随机的时间后再监听。
(3)p-坚持CSMA：空闲时以p概率直接传输；1-p概率等待到下一个时间片；忙的话等待随机时间后再监听。这是最好的。

CSMA/CD协议：先听再说、边听边说、碰撞检测 Collision Detection
+ MA:总线型,有线网络
+ CD: 半双工
+ 为什么还会冲突：是因为电磁波在总线上是有限速度的。
+ 争用期/冲突窗口/碰撞窗口：最长需要 2T,2倍传播时延，才能知道碰撞了没。最短需要0.
+ 重传/退避时间：截断二进制指数规避算法。2rT, r是重0-2^k-1取的，k是第k次重传。最多重传16次。
+ 最小帧长：很短的帧可能碰撞了也不知道，或者之后才知道。所以帧要够大。以太网是64B。

CSMA/CA :想听再说，有礼貌的，碰撞避免 Collision Avoidance
+ 用于无线局域网。因为用CD的话没法全面360度检测电，或者隐蔽的站没法检测到信号。
+ 发送前检测空闲
+ 空闲则发送 RTS(Request to send) 信号，包含发射端地址、接收端地址、下一份数据持续发送时间。信道忙则等待
+ 接收端响应CTS(Clear to send)
+ 发送端收到CTS，开始发送数据帧。并且`预约信道`，别人可以知道要等多久
+ 接收端用CRC检验，响应ACK
+ 发送方没有收到ACK，则和CSMA/CD进行指数退避

轮询协议：令牌传递协议
+ 主节点轮流邀请从节点发送数据
+ 问题：轮询开销、等待延迟、单点故障
+ 令牌：一个特殊格式的MAC控制帧、不含任何信息
+ 只有持有令牌的机器可以发，令牌环无碰撞。发完给下一个人令牌
+ 问题：令牌开销、等待延迟、单点故障
+ 常用物理星型拓扑、逻辑环形拓扑
+ 常用于负载较重，通信量大的网络。这样不用反复交换令牌


局域网 LAN
+ Local Area Network。广播信道
+ 地理范围小
+ 数据传输速率高
+ 延迟时间短、无码率低、可靠性低
+ 以太网： CSMA/CD : `IEEE 802.3`。便宜简单 10Mbps-10Gbps。 只实现无差错接收，不保证可靠传输
+ 无线局域网： `IEEE 802.11`
+ 令牌环网、FDDI完、ATM网：普通用不上

10BASE-T以太网
+ IEEE 802.3
+ 基带信号。
+ 双绞线：每段最长100米
+ 10Mbps
+ 物理上星型
+ 逻辑上总线型
+ 曼切斯特编码
+ CSMA/CD 访问控制
+ 100BASE-T就是百兆以太网
+ 10G以太网用光纤、用交换机全双工没有争用问题

适配器(网卡)
+ 网路接口板
+ 上面有处理器和存储器
+ ROM上有硬件地址
+ 上面有MAC(默认是全球唯一)地址：48位二进制，前24位是厂家
+ 以太网MAC帧V2格式：6B 目的地址，6B 源地址，2B 类型，46-1500B 数据MTU，4B FCS(用于CRC)

无线局域网
+ IEEE 802.11
+ WIFI是802.11b或者802.11g。无线局域网的空间可以很大，而wifi只是几个房间
+ AP：基站，无线接入点

广域网
+ 连接多个城市、国家
+ `分组交换`技术
+ 可以连接多个局域网

广域网--PPP协议
+ 在链路层
+ 只能全双工
+ 简单：对于链路层，无需纠错，无需序号，无需流量控制
+ 封装成帧：帧定界符
+ 透明传输
+ 支持多种网络层协议
+ 多种类型链路：串行/并行，同步/异步
+ 差错检查：错就丢弃。不用保证可靠传输
+ 检测连接状态
+ 最大传送单元
+ 网络层地址协商
+ 数据压缩协商
+ 不需要纠错、流量控制、帧序号、不需要多线路

广域网--HDLC协议
+ 实际不会用他，又是ISO搞的。High-Level Data LInk Control
+ 面向比特的

链路层设备
+ 集线器：只有转发，所有口都转发，没有过滤。超过100米不好恢复信号了。单个集线器内连的称为“冲突域”
+ 光纤：可以拓展以太网范围。 主机--光纤调制器--光纤解调器--集线器
+ 主干集线器：可以连多个集线器，拓展以太网
+ 网桥：根据MAC目的地址对帧进行转发和过滤。过滤通信量，增大吞吐量。可以连不同物理层、不同MAC子层、不同速率以太网
+ 网段：一个网络中同一物理设备(传输介质、中继器、集线器等)能直接通信的部分。
+ 透明网桥：不知道帧会去哪几个网桥，即插即用，用自学习算法，学习出转发表
+ 源路由网桥：发送帧时，把路由最少或者时间最短的信息放在帧的首部。方法，源站以广播方式向目的站发送发现帧
+ 交换机：就是多接口网桥
+ 直通式交换机：查完目的地址6Byte就立刻转发。延迟小，可靠性低，不支持不同速率端口交换
+ `存储转发交换机`：将帧放入高速缓存，检查正确性。延迟大，可靠性高，支持不同速率。实际会用这个
+ `冲突域`是指同一时间只能一台设备发送信息，`广播域`是指能收到广播信号的范围。物理层不能隔离两个域，链路层只能隔离冲突域，网络层都可以隔离


# 网络层

网络层主要任务：
+ 把`分组` 从源端传到目的端，为分组交换网上的不同主机提供通信服务。
+ 网络层的传输单位是`数据报`
+ 路由选择和分组转发(最佳路径)
+ 异构网络互连(`路由器`)
+ 拥塞控制(静态的叫开环控制，动态的叫闭环控制😳)

数据交换方式
+ 电路交换
+ 报文交换
+ 分组交换(数据报方式，虚电路方式)

电路交换
+ 打电话(建立连接，通信，释放连接)
+ 需要独占资源
+ 优点：通信时延小、有序传输、无冲突、实时性强
+ 缺点：建立连接时间长，线路独占使用效率低，灵活性查，无差错控制能力

报文交换
+ 报文：源应用发送的信息整体
+ 无需建立连接
+ 存储转发，动态分配线路
+ 线路可靠性较高
+ 线路利用率高
+ 多目标服务
+ 有存储转发时延
+ 报文大小不定，需要网络节点有较大缓存空间

分组交换
+ 分组：把报文切成小的数据块。可以是相同大小的
+ 无需建立连接
+ 存储转发，动态分配效率
+ 线路可靠性较高
+ 线路利用率搞
+ `存储管理比报文交换更容易`
+ 有存储转发时延
+ 需要传输额外的信息量
+ 乱序到目的主机时，需要对分组排序重组

> 报文交换和分组交换都采用 `存储转发`

> 传输数据大，距离远时，电路交换时延最小

> 从利用率上，分组交换好

> `分组交换-- 数据报方式`为网络提供`无连接服务`.传输无确定路径

> `分组交换--虚电路方式`提供`连接服务`.传输有确定路径，直到销毁

几种单位：
+ 报文。应用层
+ 报文段。传输层
+ 分组/IP数据报。网络层。每个分组携带源地址和目的地址
+ 帧。数据链路层
+ 比特流。物理层

`分组路由器`
+ 根据目的地址和源地址检索转发表
+ 根据路由协议建转发表
+ 每个分组独立选路

虚电路
+ 源主机到目的主机类似电路的路径(逻辑连接)，上面所有节点都要知道虚电路信息
+ 源主机发送“呼叫请求”，收到“呼叫应答”后相当于建立了虚电路
+ 源主机发送“释放请求”来释放虚电路

IP数据报
+ IP报=首部+数据部分(TCP段、UDP段)
+ 用4Byte对齐的，不够要填充的
+ 太大了就分片了，每个分片叫`分组`
+ 首部=固定部分(20Byte)+可变部分
+ 固定部分=版本(4b,v4或v6)+首部长度(4b，单位是4B对齐的，至少为5，因为固定就20B了) + 区分服务(8b,实际很少用他) +
 总长度(16b，单位B，整个IP报的长度)+标识+标志+片偏移+生存时间(8b，每经过一个路由器减一，经过太多就没用了)+
 协议(8b，比如TCP是6，UDP是17)+首部校验和+源地址(4B)+目的地址(4B)
 
最大传送单元MTU
+ 链路层数据帧可以封装的数据的上限
+ 以太网的MTU是1500B

+ 分片
+ IP分组需要同意分片。如果禁止分片则报错
+ 超过MTU可以分片
+ 标识：同一数据报的分片使用同意标识

# IPV4地址
全世界唯一的32位/4字节标识符 = 网络号 + 主机号

+ A类：网络号占1B： 1-126 (0开头)
+ B类：网络号占2B：128-191 (10)
+ C类：占3B：192-223 (110)
+ D类：224-239 (1110) ：多播地址
+ E类：240-255 (1111) ：保留
+ 0.0.0.0：仅表示本网范围内源地址，表示的本主机
+ 0.0.0.x: 仅表示本网范围内目的地址
+ 255.255.255.255：进表示本网范围内的目的地址，本网广播地址(路由器不转发)
+ x.x.x.0: 表示一个网络
+ x.x.x.255:对特定网络上的广播地址
+ 127.x.x.x：本地软件测试环回地址
+ ISP：Internet Service Provider，网络服务供应商


NAT：Network Address Translation
+ NAT路由器：把内网地址和外网地址进行转换，这个路由器至少有一个外部全球IP地址。
+ 填的目的地址就是这个NAT路由器外网地址
+ NAT转换： IP+PORT <--> IP+PORT,通过端口号来替换成具体的主机端口

子网划分
+ 可以使内部的IP更加自由一些
+ 自己网络内把主机号部分划分为 子网号+主机号
+ 对外看起来仍然是同一个网络
+ 子网号不能全0(本网络)或者全1(广播分组)
+ 子网掩码：连续的1(网络号+子网号)+连续的1(主机号)
+ 通过子网掩码做按位与操作可以得到具体IP是哪个 网络号+ 子网号

无分类编址CIDR
+ 变长子网掩码，主机号数量可以不固定。子网掩码越短，可以分配的主机号越多
+ 消除A类、B类、C类地址以及划分子网的概念
+ CIDR=网络前缀+主机号。
+ 融合了子网地址和子网掩码，方便子网划分
+ 记法：IP/网络前缀
+ 128.14.32.0/20 表示前20位是网络地址
+ 如果网络相同，那么网络前缀位数相同，且前n位相同(二进制来看)

构成超网/路由聚合
+ 把多个子网聚合成较大的子网
+ 方法：将网络的前缀缩短
+ 最长前缀匹配：使用CIDR时，可能得到几个匹配的结果，应取最长网络前缀的路由。前缀越长，路由越具体

ARP协议：IP地址与MAC地址的映射。完成主机或者路由器IP地址到MAC地址的映射。
<br> DHCP：地址重用，新主机加入网络时动态分配地址，地址续租。基于UDP。
<br>ICMP差错报告报文：网际控制报文协议，在网络层：终点不可达、源点抑制，时间超过，参数问题：使用PING或者Traceroute


# IPV6
+ 从根本上解决地址耗尽问题(CIDR、NAT不彻底)
+ 改进首部格式
+ 快速处理、转发数据报
+ 支持Qos(Quality of Service).用来减少延迟和阻塞等问题

IPV6数据报格式
+ 40B的基本首部+ 有效载荷(不超过64KB)
+ 有效载荷 = 扩展首部(可能有) + 数据部分
+ 基本首部=版本+优先级+流标签+有效载荷长度，下一个首部+跳数限制+源地址(128bit,16B)+目的地址(128b)

IPV6与IPV4
+ 地址从4B变16B
+ 校验和字段移除，加快每跳处理时间
+ 可选字段移出基本首部，放到扩展首部，加快路由器处理
+ 即插即用，自动配置，不需要DHCP
+ 首部长度必须是8B的整数倍，而V4是4B的整数倍
+ V6只能在主机处分片，V4可以在路由器或主机处分片

IPV6地址表示
+ 冒号十六进制记法
+ 压缩形式：对连续的0压缩

IPV6向IPV4过渡
+ 双栈协议：同一设备上启用IPV4和IPV6
+ 隧道技术：隧道协议将其他协议的数据帧或包重新封装。IPV6作为IPV4的数据部分进行包装。IPV6->IPV4->IPV4->IPV6

# 路由算法

最佳路由：一般是通过的路径最短。
+ 静态路由算法：不能自适应，由管理员手工分配路由信息。简单可靠，可以用于军事网络和小商业网络
+ 动态路由算法：自适应的。路由更新快，适用大型网络，及时响应链路费用和网络拓扑变化。算法复杂，增加网络负担。
+ 全局性的动态路由算法：所有路由器掌握完整的拓扑和链路信息。比如OSPF，链路状态路由算法。
+ 分散性的动态路由算法：只知道附近的路由器知道的。比如RIP，距离向量路由算法。

分层次路由选择协议
+ 因特网规模很大
+ 自治系统AS不想让外界知道自己的协议。不知道也加快外部的路由
+ 内部网关协议IGP：RIP、OSPF
+ 外部网关协议EGP：AS之间用，比如BGP-4

RIP协议
+ 距离向量路由选择协议
+ 优点是简单
+ 要求网络中每个路由器都维护从它到其他每个目的网络的唯一最佳距离记录
+ 直接交付的距离是1，距离超过16是不可达的。不能直接交付则向后简介交付
+ 只适用于小的互联网
+ 仅和相邻路由器交换信息，交换的信息是自己的路由表，每30秒交换一次
+ 若干次交换后就“收敛”了
+ RIP是应用层协议，使用UDP传送数据
+ 好消息传的快，坏消息传的慢。出现故障时很久才会传出去

OSPF
+ 最短路径优先(因为使用了Dijkstra算法)协议
+ 洪泛法向AS内所有路由器发送信息，即广播
+ 发送的信息是本路由器相邻的路由器的链路状态，比如费用、距离、时延、带宽
+ 链路状态发生变化时，路由器才向所有路由器洪泛
+ 最后，所有路由器都知道其他了

BGP协议
+ 与其他AS的邻站BGP发言人交换信息
+ BGP发言人往往是AS的边界上的路由器
+ 交换网络的可达性信息。即到达某个网络需要经过的一系列AS
+ 发生变化时才交换变化的部分

IP数据报的三种传输方式
+ 单播：点对点
+ 广播：点对多点，发送到广播域或子网内所有设备
+ 组播(即多播)：点对多点，只是到近距离了才开始复制和分发。组播路由器可以允许跨多个网络发组播

组播
+ 组播地址：属于多播组的设备会分配组播组IP地址。是224.0.0.0到239.255.255.255的D类地址，只能作为目的地址，不能作为源地址
+ 组播不提供可靠交付，应用UDP
+ 组播数据报不产生ICMP差错报文
+ D类地址不是所有都可以作为组播地址
+ 硬件组播：只能本局域网内。通过IGMP协议，路由器可以知道局域网是哪个是否有主机参加或退出了某个组播组
+ 因特网组播：跨出局域网了。组播路由选择协议：找出以源主机为根节点的组播转发树。


移动IP
+ 不是动态IP(DHCP)
+ IP地址不变，而物理地址变换
+ 固定网络IP地址，实现不同网段的`漫游`
+ 移动结点：具有永久IP地址的移动设备
+ 归属带来(本地代理)：移动管理功能的实体
+ 外部代理：在外部网络中帮助移动节点完成移动管理功能的实体
+ 移交地址(辅地址)：在外部网络中使用的临时地址

路由器
+ 有多个输入端口和多个输出端口
+ 任务是转发分组

三层设备的区别
+ 路由器：可以互联两个不同网络层协议的网段
+ 网桥：可以互联两个物理层和链路层不同的网段
+ 集线器：不能互联两个物理层不同的网段

# 传输层

+ 只有主机才有的层次
+ 提供进程和进程之间的逻辑通信(而网络层是主机之间)
+ 复用和分用
+ 传输层对收到的报文进行差错检测
+ 两种协议 TCP和UDP

# 传输层的寻址和端口
+ 复用：所有进程可以通过传输层到网络层
+ 分用：传输层收到后应该交付给特定进程
+ 端口是软件端口(逻辑上的)，标识主机中的进程
+ 端口号只有本地意义，别的机器不关心
+ 端口号16bit，有65536个
+ (服务端)知名端口号0-1023， (服务端)登记端口号：1024-49151；(客户端)动态端口号 49152-65535
+  FTP：21, TELNET:23, SMTP:25, DNS:53, TFTP:69, HTTP:80, SNMP:161
+ Socket = HOST+PORT,可以唯一标识一个主机和进程



## UDP
+ 在传输层
+ 无连接
+ 不可靠。只是最大交付，由应用层自己去保证
+ 收到UDP报文后不需要给确认
+ 时延小：适合小文件：比如QQ、微信消息
+ 只是在IP数据报上增加了复用分用和差错检测
+ 面向报文：意思是保留了应用层的报文不改变，只是加了UDP头。一次发送完整报文，不切，由网络层去切。因此适合少量数据传输。
+ 无拥塞控制，适合很多实时应用：可以丢一些数据，但是延迟小就好了
+ 首部开销小：是8B，而TCP是20B
+ 首部格式：2B源端口号+2B目的端口号+2B的UDP长度，2B的UDP检验和


## TCP
+ 在传输层
+ 面向连接(虚连接)
+ 因此只能点对点，连接两个端点
+ 可靠：无差错、不丢失、不重复、按序到达。可靠有序、不丢不重
+ 提供全双工通信：两边都有发送缓存(准备发送的和尚为确认收到的)和接收缓存(按序到达且没读取的数据或者不按序到达的数据)
+ TCP面向字节流：仅仅是一连串的有序的无结构的字节流。Nagle算法 又会合并多个小的包，就是`粘包`，当然可以在应用层解决，比如固定长度，比如首位特殊符号，或者关闭Nagle合并。 
+ 传数据前需要建立连接、传完释放连接。收到需要确认，有窗口的
+ 时延大、适用大文件：比如QQ发送大文件
+ 额外的控制开销
+ 不提供广播或多播

## TCP连接管理
三次握手、四次挥手

<br>三次握手
+ Round1：客户端发送连接请求报文段，无应用手机，SYN=1,seq=x(随机)
+ Round2：服务端为TCP连接`分配缓存和变量`，返回确认报文段，允许连接，无应用层数据。SYN=1, ACK=1,seq=y,ack=x+1(期待第一个字节)
+ Round3:客户端为TCP连接`分配缓存和变量`，并且对确认进行确认，可以带应用数据。SYN=0,ACK=1,seq=x+1, ack=y+1.
+ 洪泛攻击:攻击者不断发送SYN想握手，服务端一直ACK，攻击者不再对ACK进行ACK，服务端不断的分配资源。解决，需要设置SYN cookie。

<br>四次挥手
+ Round1:客户端发送连接释放报文段，停止发送数据。FIN=1,seq=u(上次的位置)
+ Round2:服务端会送一个确认报文段，客户-> 服务端的单向连接释放了，`半关闭状态`。ACK=1,seq=v,ack=u+1
+ Round3:服务端发完数据，发出释放报文段。FIN=1，seq=w，ack=u+1。等待关闭
+ Round4:客户端返回ACK，等到2MSL时间。彻底关闭。ACK=1，seq=u+1,ack=w+1
+ 如果不等2MSL，服务端可能收不到，可能一直等待

## TCP可靠传输
+ 可靠：收到的字节流是完全按序的发送的字节流量控制
+ 校验、序号、确认、重传
+ 序号：一个字节占一个序号
+ 确认使用累计确认
+ 重传是超时重传：动态自适应，动态改变重传时间RTTs(加权平均往返时间)
+ `冗余ACK`：返回期待收到的下一个字节(不管乱不乱序接收)，而不是返回收到的字节。
+ `快速重传`：因为有`冗余ACK`，发送端知道了接收端很久缺什么

## TCP的流量控制(反压)
+ 发送方你发慢点，是点到点的问题
+ TCP是滑动窗口
+ 接收发可以在确认报文段将rwnd发给发送方，告诉我能接收多大
+ 发送窗口=min{接收窗口rwnd,拥塞窗口cwnd}
+ 接收窗口：接收方的缓存容量，告诉发送方；
+ 拥塞窗口：发送方估算的拥塞程度，当前网络容量

## TCP的拥塞控制
+ 对于资源需求总和(比如总带宽，路由器上cpu、缓存) > 可用资源， 是需要协调多个主机的，全局上的问题
+ 防止过多的数据同时注入到网络中
+ (发送端)慢开始+拥塞避免: cwnd=1,4,8,16,... 指数增大拥塞窗口；到了16(老的门限值)了进行慢开始，16,17,18,19,21...加法增大；在24遇到拥塞，减低门限值为一半12，立刻降回1，，重新开始指数增大。
+ (发送端)快重传+快恢复：发送端连续收到3个`冗余ACK`，立刻重传。这种拥塞不用降为1，降到12，然后继续加法增大。
